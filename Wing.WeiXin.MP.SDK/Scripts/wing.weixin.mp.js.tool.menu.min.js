/*!
 * Weixin JS Menu Tool v0.0.5
 * 用于图形化操作菜单
 *
 * Dependency：
 * 1.JQuery
 * 2.Bootstrap(V3)
 *
 * Update(v0.0.5)：
 * [Change]调整显示提示的方式
 * 
 * Usage：
 * $('#main').weixinmenu({
 *     getUrl: '/Menu?Operation=Get',       //获取菜单APIUrl
 *     saveUrl: '/Menu?Operation=Save',     //保存菜单APIUrl
 *     deleteUrl: '/Menu?Operation=Delete'  //删除菜单APIUrl
 * });
 */
!function (a) { "use strict"; function h(a) { var d, b = '<div id="' + e + 'operate" class="btn-group" role="group">' + '<button type="button" id="' + e + 'operate-refrush" class="btn btn-primary">刷新菜单</button>' + '<button type="button" id="' + e + 'operate-save" class="btn btn-success">保存菜单</button>' + '<button type="button" id="' + e + 'operate-delete" class="btn btn-warning">删除菜单</button>' + "</div>" + '<div id="' + e + 'main" class="panel-group" role="tablist" aria-multiselectable="true">'; for (d = 0; c > d; d++) b += '<div class="panel panel-default"><div class="panel-heading" role="tab" id="' + e + "heading-" + d + '" data-toggle="collapse" data-parent="#' + e + 'main" data-target="#' + e + "collapse-" + d + '" aria-expanded="false" aria-controls="' + e + "collapse-" + d + '">' + "<h4>主菜单" + (d + 1) + "</h4>" + "</div>" + '<div id="' + e + "collapse-" + d + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="' + e + "heading-" + d + '">' + '<div class="panel-body">' + '<div class="panel panel-success">' + '<div id="' + e + "head-" + d + '" class="panel-heading"></div>' + '<div id="' + e + "body-" + d + '" class="panel-body"></div>' + '<div id="' + e + "footer-" + d + '" class="panel-footer btn-group" role="group"></div>' + "</div>" + "</div>" + "</div>" + "</div>"; a.html(b + "</div>"), i(a) } function i(b) { a("#" + e + "operate-refrush").click(function () { k(b) }), a("#" + e + "operate-save").click(function () { y("确定保存？", function () { z(), a.post(g.saveUrl, { Data: window.escape(JSON.stringify(j())) }, function (a) { A(), B(a.msg) }) }) }), a("#" + e + "operate-delete").click(function () { y("确定删除？", function () { z(), a.post(g.deleteUrl, function (a) { A(), B(a.msg) }) }) }) } function j() { var d, f, g, h, b = []; for (d = 0; c > d; d++) f = a("#" + e + "head-" + d).text(), "" != f && (g = a("#" + e + "head-" + d).data("menu-type"), "main" == g ? (h = [], a("#" + e + "body-" + d).children().children().each(function () { var b = a(this).find('p[data-menu-type="type"]').eq(0).data("menu-value"), c = a(this).find('p[data-menu-type="name"]').eq(0).data("menu-value"); h = "view" == b ? h.concat([{ name: c, type: b, url: a(this).find('p[data-menu-type="url"]').eq(0).data("menu-value") }]) : h.concat([{ name: c, type: b, key: a(this).find('p[data-menu-type="key"]').eq(0).data("menu-value") }]) }), b = b.concat([{ name: f, sub_button: h }])) : b = "view" == g ? b.concat([{ name: f, type: g, url: a("#" + e + "head-" + d).data("menu-url") }]) : b.concat([{ name: f, type: g, key: a("#" + e + "head-" + d).data("menu-key") }])); return { menu: { button: b } } } function k(b) { z(), h(b), a.getJSON(g.getUrl, function (b) { "undefined" != typeof b.msg && (B(b.msg), b = { button: [] }); for (var d = 0; c > d; d++) d < b.button.length ? (a("#" + e + "head-" + d).text(b.button[d].name), l(d, b.button[d], !0, !0)) : n(d); A() }) } function l(b, c, d, f, g) { return "undefined" != typeof g && null != g ? (g.html(m(c)), void 0) : (d ? (a("#" + e + "head-" + b).text(c.name), "undefined" == typeof c.type ? (a("#" + e + "head-" + b).attr("data-menu-type", "main"), a("#" + e + "body-" + b).html('<ul class="list-group"></ul>'), "undefined" != typeof c.sub_button && c.sub_button.length > 0 && c.sub_button.forEach(function (c) { a("#" + e + "body-" + b).children().append('<li class="list-group-item ' + e + 'menu-item">' + m(c) + "</li>") }), n(b, a("#" + e + "body-" + b).children().children().length)) : (a("#" + e + "head-" + b).attr("data-menu-type", c.type), "view" == c.type ? a("#" + e + "head-" + b).attr("data-menu-url", c.url) : a("#" + e + "head-" + b).attr("data-menu-key", c.key), a("#" + e + "body-" + b).html(m(c)), n(b, -1))) : (a("#" + e + "body-" + b).children().append('<li class="list-group-item ' + e + 'menu-item">' + m(c) + "</li>"), n(b, a("#" + e + "body-" + b).children().children().length)), a("." + e + "menu-item").unbind(), a("." + e + "menu-item").click(function () { v(!1, !1, b, a(this)) }), void 0) } function m(a) { var b = '<p data-menu-type="name" data-menu-value="' + a.name + '"><strong>显示标题：' + a.name + "</strong></p>", c = '<p data-menu-type="type" data-menu-value="' + a.type + '">类型：' + a.type + "(" + t(a.type) + ")</p>", d = "view" == a.type ? '<p data-menu-type="url" data-menu-value="' + a.url + '">URL：' + a.url + "</p>" : '<p data-menu-type="key" data-menu-value="' + a.key + '">Key：' + a.key + "</p>"; return b + c + d } function n(a, b) { return "undefined" == typeof b ? (s(a, !0), void 0) : 0 > b ? (r(a, !0), q(a), void 0) : 0 == b ? (o(a, !0), r(a), q(a), void 0) : 5 == b ? (r(a, !0), p(a), void 0) : (o(a, !0), r(a), p(a), void 0) } function o(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + b).empty(); var d = '<button type="button" class="btn btn-info" data-menu-event="AddSub" data-menu-id="' + b + '">添加子菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="AddSub"][data-menu-id="' + b + '"]').click(function () { v(!0, !1, b) }) } function p(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + b).empty(); var d = '<button type="button" class="btn btn-warning" data-menu-event="DeleteSub" data-menu-id="' + b + '">删除子菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="DeleteSub"][data-menu-id="' + b + '"]').click(function () { y("确定删除？", function () { a("#" + e + "body-" + b).children().children().remove("li:last"); var c = a("#" + e + "body-" + b).children().children(); n(b, c.length) }) }) } function q(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + (b + 1)).empty(); var d = '<button type="button" class="btn btn-danger" data-menu-event="DeleteMain" data-menu-id="' + b + '">删除主菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="DeleteMain"][data-menu-id="' + b + '"]').click(function () { y("确定删除？", function () { a("#" + e + "head-" + b).removeAttr("data-menu-type"), a("#" + e + "head-" + b).empty(), a("#" + e + "body-" + b).empty(), a("#" + e + "footer-" + b).empty(), n(b) }) }) } function r(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + b).empty(); var d = '<button type="button" class="btn btn-primary" data-menu-event="ModityMain" data-menu-id="' + b + '">修改主菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="ModityMain"][data-menu-id="' + b + '"]').click(function () { v(!1, !0, b) }) } function s(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + b).empty(); var d = '<button type="button" class="btn btn-success" data-menu-event="AddMain" data-menu-id="' + b + '">添加主菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="AddMain"][data-menu-id="' + b + '"]').click(function () { v(!0, !0, b) }) } function t(a) { return "click" == a ? "点击推事件" : "view" == a ? "跳转URL" : "scancode_push" == a ? "扫码推事件" : "scancode_waitmsg" == a ? "扫码推事件且弹出“消息接收中”提示框" : "pic_sysphoto" == a ? "弹出系统拍照发图" : "pic_photo_or_album" == a ? "弹出拍照或者相册发图" : "pic_weixin" == a ? "弹出微信相册发图器" : "location_select" == a ? "弹出地理位置选择器" : "未知类型" } function u(a, b) { var c = "undefined" != typeof b && null != b, d = ""; return a && (d += '<option value="main"' + (c && "main" == b ? 'selected="selected"' : "") + ">主菜单</option>"), d += '<option value="click"' + (c && "click" == b ? 'selected="selected"' : "") + ">点击推事件</option>" + '<option value="view"' + (c && "view" == b ? 'selected="selected"' : "") + ">跳转URL</option>" + '<option value="scancode_push"' + (c && "scancode_push" == b ? 'selected="selected"' : "") + ">扫码推事件</option>" + '<option value="scancode_waitmsg"' + (c && "scancode_waitmsg" == b ? 'selected="selected"' : "") + ">扫码推事件且弹出“消息接收中”提示框</option>" + '<option value="pic_sysphoto"' + (c && "pic_sysphoto" == b ? 'selected="selected"' : "") + ">弹出系统拍照发图</option>" + '<option value="pic_photo_or_album"' + (c && "pic_photo_or_album" == b ? 'selected="selected"' : "") + ">弹出拍照或者相册发图</option>" + '<option value="pic_weixin"' + (c && "pic_weixin" == b ? 'selected="selected"' : "") + ">弹出微信相册发图器</option>" + '<option value="location_select"' + (c && "location_select" == b ? 'selected="selected"' : "") + ">弹出地理位置选择器</option>" } function v(b, c, d, g) { var h, i; a("body").append('<div id="' + f + 'main" class="modal fade" role="dialog" aria-hidden="true">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-header">' + '<h4 class="modal-title">' + (b ? "新建" : "修改") + (c ? "主" : "子") + "菜单</h4>" + "</div>" + '<div id="' + f + 'body" class="modal-body">' + '<div class="form-group">' + '<label for="' + f + 'name" class="sr-only">菜单名称</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'name" name="name" class="form-control" placeholder="菜单名称">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-book"></div>' + "</div>" + "</div>" + "</div>" + "</div>" + '<div class="modal-footer">' + '<button type="button" id="' + f + 'save" class="btn btn-primary">保存</button>' + '<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>' + "</div>" + "</div>" + "</div>" + "</div>"), b || a("#" + f + "name").val(c ? a("#" + e + "head-" + d).text() : g.find('p[data-menu-type="name"]').eq(0).data("menu-value")), h = b || "main" != a("#" + e + "head-" + d).data("menu-type") || 0 == a("#" + e + "body-" + d).children().children().length, h && (i = b ? null : c ? a("#" + e + "head-" + d).data("menu-type") : g.find('p[data-menu-type="type"]').eq(0).data("menu-value"), a("#" + f + "body").append('<div class="form-group"><label for="' + f + 'type" class="sr-only">菜单类型</label>' + '<div class="input-group">' + '<select id="' + f + 'type" name="type" class="form-control">' + u(c, i) + "</select>" + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-th-list"></div>' + "</div>" + "</div>" + "</div>"), a("#" + f + "body").append(x(d, a("#" + f + "type").val(), c, g)), a("#" + f + "type").change(function () { var b = a(this).val(); a("#" + f + "body").append(x(d, b, c, g)) })), a("#" + f + "main").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + f + "save").click(function () { w(b, c, d, h, g) }), a("#" + f + "main").modal("show") } function w(b, c, d, g, h) { var j, k, m, n, i = a("#" + f + "name").val(); if (0 == i.length) return B("主菜单名称不能为空"), void 0; if (i.length > 16) return B("主菜单名称不能超过16个字节"), void 0; if (g) { if (j = a("#" + f + "type").val(), k = { name: i }, "main" != j) if (k = a.extend({ type: j }, k), "view" == j) { if (m = a("#" + f + "url").val(), k = a.extend({ url: m }, k), 0 == m.length) return B("URL不能为空"), void 0 } else if (n = a("#" + f + "key").val(), k = a.extend({ key: n }, k), 0 == n.length) return B("Key不能为空"), void 0; c ? b ? "main" == j ? l(d, k, !0, !0) : l(d, k, !0, !0) : "main" == j ? l(d, k, !0, !1) : l(d, k, !0, !1) : b ? l(d, k, !1, !0) : l(d, k, !1, !1, h) } else a("#" + e + "head-" + d).text(i); a("#" + f + "main").modal("hide") } function x(b, c, d, g) { if (a("." + f + "arg").remove(), null == c) { if ("undefined" == typeof g || null == g) return ""; c = g.find('p[data-menu-type="type"]').eq(0).data("menu-value") } if ("main" == c) return ""; var h; return "view" == c ? (h = d ? a("#" + e + "head-" + b).data("menu-type") == c ? a("#" + e + "head-" + b).data("menu-url") : "" : null != g && g.find('p[data-menu-type="type"]').eq(0).data("menu-value") == c ? g.find('p[data-menu-type="url"]').eq(0).data("menu-value") : "", '<div class="form-group ' + f + 'arg">' + '<label for="' + f + 'url" class="sr-only">URL</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'url" name="url" value="' + h + '" class="form-control" placeholder="URL">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-pencil"></div>' + "</div>" + "</div>" + "</div>") : (h = d ? a("#" + e + "head-" + b).data("menu-type") == c ? a("#" + e + "head-" + b).data("menu-key") : "" : null != g && g.find('p[data-menu-type="type"]').eq(0).data("menu-value") == c ? g.find('p[data-menu-type="key"]').eq(0).data("menu-value") : "", '<div class="form-group ' + f + 'arg">' + '<label for="' + f + 'key" class="sr-only">Key</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'key" name="key" value="' + h + '" class="form-control" placeholder="Key">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-pencil"></div>' + "</div>" + "</div>" + "</div>") } function y(b, c) { a("body").append('<div id="' + e + 'confirm" class="modal fade" role="dialog" aria-hidden="true">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-header">' + '<h4 class="modal-title">提示</h4>' + "</div>" + '<div class="modal-body">' + "<p><strong>" + b + "</strong></p>" + "</div>" + '<div class="modal-footer">' + '<button type="button" id="' + e + 'confirm-ok" class="btn btn-primary">确定</button>' + '<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>' + "</div>" + "</div>" + "</div>" + "</div>"), a("#" + e + "confirm").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + e + "confirm-ok").click(function () { c(), a("#" + e + "confirm").modal("hide") }), a("#" + e + "confirm").modal("show") } function z() { a("body").append('<div id="' + e + 'loading" class="modal fade" data-backdrop="static">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-body">' + "<p>Loading。。。</p>" + "</div>" + "</div>" + "</div>" + "</div>"), a("#" + e + "loading").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + e + "loading").modal("show") } function A() { a("#" + e + "loading").modal("hide") } function B(b) { a("body").append('<div id="' + e + 'message-alert" class="alert alert-info alert-dismissible fade in" role="alert" style="display:none;z-index:9999;position:fixed;left:0;top:0;right:0">' + "<strong>" + b + "</strong>" + "</div>"), a("#" + e + "message-alert").slideDown("fast"), setTimeout(function () { a("#" + e + "message-alert").alert("close") }, d) } var g, b = "weixinmenu", c = 3, d = 2e3, e = "weixin-tool-menu-", f = e + "menu-edit-"; a.fn[b] = function (b) { g = a.extend({ getUrl: "/MenuTool?Operation=Get", saveUrl: "/MenuTool?Operation=Save", deleteUrl: "/MenuTool?Operation=Delete" }, b), k(a(this)) } }(jQuery);