/*!
 * Weixin JS Menu Tool v0.0.7
 * 用于图形化操作菜单
 *
 * Dependency：
 * 1.JQuery
 * 2.Bootstrap(V3)
 *
 * Update(v0.0.7)：
 * [Add]添加菜单上下移动按钮
 * [Change]调整删除子菜单按钮方式
 * [Change]调整View菜单URL显示方式
 * 
 * Usage：
 * $('#main').weixinmenu({
 *     getUrl: '/Menu?Operation=Get',                   //获取菜单APIUrl
 *     saveUrl: '/Menu?Operation=Save',                 //保存菜单APIUrl
 *     deleteUrl: '/Menu?Operation=Delete',             //删除菜单APIUrl
 *     getOAuthUrlUrl: '/Menu?Operation=GetOAuthUrl',   //获取OAuth地址APIUrl
 *     oauthCallback: ''                                //OAuth回调地址
 * });
 */
!function (a) { "use strict"; function h(a) { var d, b = '<div id="' + e + 'operate" class="btn-group" role="group">' + '<button type="button" id="' + e + 'operate-refrush" class="btn btn-primary">刷新菜单</button>' + '<button type="button" id="' + e + 'operate-save" class="btn btn-success">保存菜单</button>' + '<button type="button" id="' + e + 'operate-delete" class="btn btn-warning">删除菜单</button>' + "</div>" + '<div id="' + e + 'main" class="panel-group" role="tablist" aria-multiselectable="true">'; for (d = 0; c > d; d++) b += '<div class="panel panel-default"><div class="panel-heading" role="tab" id="' + e + "heading-" + d + '" data-toggle="collapse" data-parent="#' + e + 'main" data-target="#' + e + "collapse-" + d + '" aria-expanded="false" aria-controls="' + e + "collapse-" + d + '">' + "<h4>主菜单" + (d + 1) + "</h4>" + "</div>" + '<div id="' + e + "collapse-" + d + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="' + e + "heading-" + d + '">' + '<div class="panel-body">' + '<div class="panel panel-success">' + '<div id="' + e + "head-" + d + '" class="panel-heading"></div>' + '<div id="' + e + "body-" + d + '" class="panel-body"></div>' + '<div id="' + e + "footer-" + d + '" class="panel-footer btn-group" role="group"></div>' + "</div>" + "</div>" + "</div>" + "</div>"; a.html(b + "</div>"), i(a) } function i(b) { a("#" + e + "operate-refrush").click(function () { k(b) }), a("#" + e + "operate-save").click(function () { B("确定保存？", function () { C(), a.post(g.saveUrl, { Data: window.escape(JSON.stringify(j())) }, function (a) { D(), E(a.msg) }, "json") }) }), a("#" + e + "operate-delete").click(function () { B("确定删除？", function () { C(), a.post(g.deleteUrl, function (a) { D(), E(a.msg) }, "json") }) }) } function j() { var d, f, g, h, b = []; for (d = 0; c > d; d++) f = a("#" + e + "head-" + d).text(), "" != f && (g = a("#" + e + "head-" + d).data("menu-type"), "main" == g ? (h = [], a("#" + e + "body-" + d).children().children().each(function () { var b = a(this).find('p[data-menu-type="type"]').eq(0).data("menu-value"), c = a(this).find('p[data-menu-type="name"]').eq(0).data("menu-value"); h = "view" == b ? h.concat([{ name: c, type: b, url: a(this).find('p[data-menu-type="url"]').eq(0).data("menu-value") }]) : h.concat([{ name: c, type: b, key: a(this).find('p[data-menu-type="key"]').eq(0).data("menu-value") }]) }), b = b.concat([{ name: f, sub_button: h }])) : b = "view" == g ? b.concat([{ name: f, type: g, url: a("#" + e + "head-" + d).data("menu-url") }]) : b.concat([{ name: f, type: g, key: a("#" + e + "head-" + d).data("menu-key") }])); return { menu: { button: b } } } function k(b) { C(), h(b), a.getJSON(g.getUrl, function (b) { "undefined" != typeof b.msg && (E(b.msg), b = { button: [] }); for (var d = 0; c > d; d++) d < b.button.length ? (a("#" + e + "head-" + d).text(b.button[d].name), l(d, b.button[d], !0, !0)) : n(d); D() }) } function l(b, c, d, f, g) { return "undefined" != typeof g && null != g ? (g.html(m(c)), void 0) : (d ? (a("#" + e + "head-" + b).text(c.name), "undefined" == typeof c.type ? (a("#" + e + "head-" + b).attr("data-menu-type", "main"), a("#" + e + "body-" + b).html('<ul class="list-group"></ul>'), "undefined" != typeof c.sub_button && c.sub_button.length > 0 && c.sub_button.forEach(function (c) { a("#" + e + "body-" + b).children().append('<li class="list-group-item ' + e + 'menu-item">' + m(c) + "</li>") }), n(b, a("#" + e + "body-" + b).children().children().length)) : (a("#" + e + "head-" + b).attr("data-menu-type", c.type), "view" == c.type ? a("#" + e + "head-" + b).attr("data-menu-url", c.url) : a("#" + e + "head-" + b).attr("data-menu-key", c.key), a("#" + e + "body-" + b).html(m(c)), n(b, -1))) : (a("#" + e + "body-" + b).children().append('<li class="list-group-item ' + e + 'menu-item">' + m(c) + "</li>"), n(b, a("#" + e + "body-" + b).children().children().length)), a("." + e + "menu-item p").unbind(), a("." + e + "menu-item p").click(function () { x(!1, !1, b, a(this)) }), void 0) } function m(a) { var b = '<p data-menu-type="name" data-menu-value="' + a.name + '"><strong>显示标题：' + a.name + "</strong></p>", c = '<p data-menu-type="type" data-menu-value="' + a.type + '">类型：' + a.type + "(" + v(a.type) + ")</p>", d = "view" == a.type ? '<div data-menu-type="url" data-menu-value="' + a.url + '">URL：<pre>' + a.url + "</pre></div>" : '<p data-menu-type="key" data-menu-value="' + a.key + '">Key：' + a.key + "</p>", e = '<div class="panel-footer btn-group" role="group"><button type="button" class="btn btn-warning" data-menu-event="DeleteSub">删除</button><button type="button" class="btn btn-warning" data-menu-event="MoveUpSub">上移</button><button type="button" class="btn btn-warning" data-menu-event="MoveDownSub">下移</button></div>'; return b + c + d + e } function n(a, b) { return p(a), q(a), r(a), "undefined" == typeof b ? (u(a, !0), void 0) : 0 > b ? (t(a, !0), s(a), void 0) : 0 == b ? (o(a, !0), t(a), s(a), void 0) : 5 == b ? (t(a, !0), void 0) : (o(a, !0), t(a), void 0) } function o(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + b).empty(); var d = '<button type="button" class="btn btn-info" data-menu-event="AddSub" data-menu-id="' + b + '">添加子菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="AddSub"][data-menu-id="' + b + '"]').unbind(), a('button[data-menu-event="AddSub"][data-menu-id="' + b + '"]').click(function () { x(!0, !1, b) }) } function p() { a('button[data-menu-event="DeleteSub"]').unbind(), a('button[data-menu-event="DeleteSub"]').click(function () { var b = a(this); B("确定删除？", function () { b.parents("li").eq(0).remove() }) }) } function q(b) { a('button[data-menu-event="MoveUpSub"]').unbind(), a('button[data-menu-event="MoveUpSub"]').click(function () { var j, c = a(this).parents("ul").eq(0), d = c.children("li"), f = a(this).parents("li").eq(0).html(), g = d.length, h = new Array, i = -1; d.each(function (a, b) { b.innerHTML == f && (i = a), h[a] = b }), -1 != i && 0 != i && (j = h[i], h[i] = h[i - 1], h[i - 1] = j, c.empty(), a.each(h, function (a, b) { c.append(b.outerHTML) }), a("." + e + "menu-item p").unbind(), a("." + e + "menu-item p").click(function () { x(!1, !1, b, a(this)) }), n(b, g)) }) } function r(b) { a('button[data-menu-event="MoveDownSub"]').unbind(), a('button[data-menu-event="MoveDownSub"]').click(function () { var j, c = a(this).parents("ul").eq(0), d = c.children("li"), f = a(this).parents("li").eq(0).html(), g = d.length, h = new Array, i = -1; d.each(function (a, b) { b.innerHTML == f && (i = a), h[a] = b }), i != g - 1 && -1 != i && (j = h[i], h[i] = h[i + 1], h[i + 1] = j, c.empty(), a.each(h, function (a, b) { c.append(b.outerHTML) }), a("." + e + "menu-item p").unbind(), a("." + e + "menu-item p").click(function () { x(!1, !1, b, a(this)) }), n(b, c.length)) }) } function s(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + (b + 1)).empty(); var d = '<button type="button" class="btn btn-danger" data-menu-event="DeleteMain" data-menu-id="' + b + '">删除主菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="DeleteMain"][data-menu-id="' + b + '"]').unbind(), a('button[data-menu-event="DeleteMain"][data-menu-id="' + b + '"]').click(function () { B("确定删除？", function () { a("#" + e + "head-" + b).removeAttr("data-menu-type"), a("#" + e + "head-" + b).empty(), a("#" + e + "body-" + b).empty(), a("#" + e + "footer-" + b).empty(), n(b) }) }) } function t(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + b).empty(); var d = '<button type="button" class="btn btn-primary" data-menu-event="ModityMain" data-menu-id="' + b + '">修改主菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="ModityMain"][data-menu-id="' + b + '"]').unbind(), a('button[data-menu-event="ModityMain"][data-menu-id="' + b + '"]').click(function () { x(!1, !0, b) }) } function u(b, c) { "undefined" != typeof c && c && a("#" + e + "footer-" + b).empty(); var d = '<button type="button" class="btn btn-success" data-menu-event="AddMain" data-menu-id="' + b + '">添加主菜单</button>'; a("#" + e + "footer-" + b).append(d), a('button[data-menu-event="AddMain"][data-menu-id="' + b + '"]').unbind(), a('button[data-menu-event="AddMain"][data-menu-id="' + b + '"]').click(function () { x(!0, !0, b) }) } function v(a) { return "click" == a ? "点击推事件" : "view" == a ? "跳转URL" : "scancode_push" == a ? "扫码推事件" : "scancode_waitmsg" == a ? "扫码推事件且弹出“消息接收中”提示框" : "pic_sysphoto" == a ? "弹出系统拍照发图" : "pic_photo_or_album" == a ? "弹出拍照或者相册发图" : "pic_weixin" == a ? "弹出微信相册发图器" : "location_select" == a ? "弹出地理位置选择器" : "未知类型" } function w(a, b) { var c = "undefined" != typeof b && null != b, d = ""; return a && (d += '<option value="main"' + (c && "main" == b ? 'selected="selected"' : "") + ">主菜单</option>"), d += '<option value="click"' + (c && "click" == b ? 'selected="selected"' : "") + ">点击推事件</option>" + '<option value="view"' + (c && "view" == b ? 'selected="selected"' : "") + ">跳转URL</option>" + '<option value="scancode_push"' + (c && "scancode_push" == b ? 'selected="selected"' : "") + ">扫码推事件</option>" + '<option value="scancode_waitmsg"' + (c && "scancode_waitmsg" == b ? 'selected="selected"' : "") + ">扫码推事件且弹出“消息接收中”提示框</option>" + '<option value="pic_sysphoto"' + (c && "pic_sysphoto" == b ? 'selected="selected"' : "") + ">弹出系统拍照发图</option>" + '<option value="pic_photo_or_album"' + (c && "pic_photo_or_album" == b ? 'selected="selected"' : "") + ">弹出拍照或者相册发图</option>" + '<option value="pic_weixin"' + (c && "pic_weixin" == b ? 'selected="selected"' : "") + ">弹出微信相册发图器</option>" + '<option value="location_select"' + (c && "location_select" == b ? 'selected="selected"' : "") + ">弹出地理位置选择器</option>" } function x(b, c, d, g) { var h, i, j; a("body").append('<div id="' + f + 'main" class="modal fade" role="dialog" aria-hidden="true">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-header">' + '<h4 class="modal-title">' + (b ? "新建" : "修改") + (c ? "主" : "子") + "菜单</h4>" + "</div>" + '<div id="' + f + 'body" class="modal-body">' + '<div class="form-group">' + '<label for="' + f + 'name" class="sr-only">菜单名称</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'name" name="name" class="form-control" placeholder="菜单名称">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-book"></div>' + "</div>" + "</div>" + "</div>" + "</div>" + '<div class="modal-footer">' + '<button type="button" id="' + f + 'save" class="btn btn-primary">保存</button>' + '<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>' + "</div>" + "</div>" + "</div>" + "</div>"), b || a("#" + f + "name").val(c ? a("#" + e + "head-" + d).text() : g.find('p[data-menu-type="name"]').eq(0).data("menu-value")), h = b || "main" != a("#" + e + "head-" + d).data("menu-type") || 0 == a("#" + e + "body-" + d).children().children().length, h && (i = b ? null : c ? a("#" + e + "head-" + d).data("menu-type") : g.find('p[data-menu-type="type"]').eq(0).data("menu-value"), a("#" + f + "body").append('<div class="form-group"><label for="' + f + 'type" class="sr-only">菜单类型</label>' + '<div class="input-group">' + '<select id="' + f + 'type" name="type" class="form-control">' + w(c, i) + "</select>" + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-th-list"></div>' + "</div>" + "</div>" + "</div>"), j = a("#" + f + "type").val(), a("#" + f + "body").append(z(d, j, c, g)), A(j), a("#" + f + "type").change(function () { var b = a(this).val(); a("#" + f + "body").append(z(d, b, c, g)), A(b) })), a("#" + f + "main").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + f + "save").click(function () { y(b, c, d, h, g) }), a("#" + f + "main").modal("show") } function y(b, c, d, g, h) { var j, k, m, n, o, i = a("#" + f + "name").val(); if (0 == i.length) return E("主菜单名称不能为空"), void 0; if (i.length > 16) return E("主菜单名称不能超过16个字节"), void 0; if (g) { if (j = a("#" + f + "type").val(), k = { name: i }, "main" != j) if (k = a.extend({ type: j }, k), "view" == j) { if (m = a("#" + f + "url").val(), k = a.extend({ url: m }, k), 0 == m.length) return E("URL不能为空"), void 0 } else if (n = a("#" + f + "key").val(), k = a.extend({ key: n }, k), 0 == n.length) return E("Key不能为空"), void 0; c ? b ? "main" == j ? l(d, k, !0, !0) : l(d, k, !0, !0) : "main" == j ? l(d, k, !0, !1) : l(d, k, !0, !1) : b ? l(d, k, !1, !0) : l(d, k, !1, !1, h) } else c ? a("#" + e + "head-" + d).text(i) : (o = h.find('p[data-menu-type="name"]').eq(0), o.attr("data-menu-value", i), o.html("<strong>显示标题：" + i + "</strong>")); a("#" + f + "main").modal("hide") } function z(b, c, d, h) { if (a("." + f + "arg").remove(), null == c) { if ("undefined" == typeof h || null == h) return ""; c = h.find('p[data-menu-type="type"]').eq(0).data("menu-value") } if ("main" == c) return ""; var i; return "view" == c ? (i = d ? a("#" + e + "head-" + b).data("menu-type") == c ? a("#" + e + "head-" + b).data("menu-url") : "" : null != h && h.find('p[data-menu-type="type"]').eq(0).data("menu-value") == c ? h.find('p[data-menu-type="url"]').eq(0).data("menu-value") : "", '<div class="form-group ' + f + 'arg">' + '<label for="' + f + 'url" class="sr-only">URL</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'url" name="url" value="' + i + '" class="form-control" placeholder="URL">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-pencil"></div>' + "</div>" + "</div>" + "</div>" + '<div class="form-group ' + f + 'arg">' + '<div class="btn-group" data-toggle="buttons">' + '<label class="btn btn-primary active">' + '<input type="radio" name="' + f + 'url-type" id="' + f + 'url-type-common" value="common" autocomplete="off" checked>普通' + "</label>" + '<label class="btn btn-primary">' + '<input type="radio" name="' + f + 'url-type" id="' + f + 'url-type-oauth" value="oauth" autocomplete="off">OAuth' + "</label>" + "</div>" + "</div>" + '<div class="form-group ' + f + "arg hidden " + f + 'arg-type">' + '<label for="' + f + 'url-oauth-callback" class="sr-only">回调地址</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'url-oauth-callback" name="url-oauth-callback" value="' + g.oauthCallback + '" class="form-control" placeholder="回调地址">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-cog"></div>' + "</div>" + "</div>" + "</div>" + '<div class="form-group ' + f + "arg hidden " + f + 'arg-type">' + '<label for="' + f + 'url-oauth-type" class="sr-only">应用授权作用域</label>' + '<select id="' + f + 'url-oauth-type" name="' + f + 'url-oauth-type" class="form-control">' + '<option value="snsapi_base">基本授权</option>' + '<option value="snsapi_userinfo">用户信息授权</option>' + "</select> " + "</div>" + '<div class="form-group ' + f + "arg hidden " + f + 'arg-type">' + '<label for="' + f + 'url-oauth-state" class="sr-only">参数</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'url-oauth-state" name="url-oauth-state" class="form-control" placeholder="参数">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-tag"></div>' + "</div>" + "</div>" + "</div>" + '<div class="form-group ' + f + "arg hidden " + f + 'arg-type">' + '<button class="btn btn-primary" id="' + f + 'url-oauth-geturl">获取OAuth地址</button>' + "</div>") : (i = d ? a("#" + e + "head-" + b).data("menu-type") == c ? a("#" + e + "head-" + b).data("menu-key") : "" : null != h && h.find('p[data-menu-type="type"]').eq(0).data("menu-value") == c ? h.find('p[data-menu-type="key"]').eq(0).data("menu-value") : "", '<div class="form-group ' + f + 'arg">' + '<label for="' + f + 'key" class="sr-only">Key</label>' + '<div class="input-group">' + '<input type="text" id="' + f + 'key" name="key" value="' + i + '" class="form-control" placeholder="Key">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-pencil"></div>' + "</div>" + "</div>" + "</div>") } function A(b) { return "view" == b ? (a('input[name="' + f + 'url-type"]').change(function () { var b = a(this).val(); "common" == b && (a("." + f + "arg-type").addClass("hidden"), a("#" + f + "url").removeAttr("readonly")), "oauth" == b && (a("." + f + "arg-type").removeClass("hidden"), a("#" + f + "url").attr("readonly", "readonly")) }), a("#" + f + "url-oauth-geturl").click(function () { var c, d, b = a("#" + f + "url-oauth-callback").val(); return 0 == b.length ? (E("OAuth回调地址不能为空"), void 0) : (c = a("#" + f + "url-oauth-type").val(), d = a("#" + f + "url-oauth-state").val(), 0 == d.length ? (E("OAuth参数不能为空"), void 0) : d.length > 128 ? (E("OAuth参数不能大于128字节"), void 0) : new RegExp("^[A-Za-z0-9]+$").test(d) ? (C(), a.post(g.getOAuthUrlUrl, { callback: b, type: c, state: d }, function (b) { return D(), "undefined" != typeof b.msg ? (E(b.msg), void 0) : (a("#" + f + "url").val(b.url), void 0) }, "json"), void 0) : (E("OAuth参数必须满足a-zA-Z0-9"), void 0)) }), void 0) : void 0 } function B(b, c) { a("body").append('<div id="' + e + 'confirm" class="modal fade" role="dialog" aria-hidden="true">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-header">' + '<h4 class="modal-title">提示</h4>' + "</div>" + '<div class="modal-body">' + "<p><strong>" + b + "</strong></p>" + "</div>" + '<div class="modal-footer">' + '<button type="button" id="' + e + 'confirm-ok" class="btn btn-primary">确定</button>' + '<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>' + "</div>" + "</div>" + "</div>" + "</div>"), a("#" + e + "confirm").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + e + "confirm-ok").click(function () { c(), a("#" + e + "confirm").modal("hide") }), a("#" + e + "confirm").modal("show") } function C() { a("body").append('<div id="' + e + 'loading" class="modal fade" data-backdrop="static">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-body">' + "<p>Loading。。。</p>" + "</div>" + "</div>" + "</div>" + "</div>"), a("#" + e + "loading").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + e + "loading").modal("show") } function D() { a("#" + e + "loading").modal("hide") } function E(b) { a("body").append('<div id="' + e + 'message-alert" class="alert alert-info alert-dismissible fade in" role="alert" style="display:none;z-index:9999;position:fixed;left:0;top:0;right:0">' + "<strong>" + b + "</strong>" + "</div>"), a("#" + e + "message-alert").slideDown("fast"), setTimeout(function () { a("#" + e + "message-alert").alert("close") }, d) } var g, b = "weixinmenu", c = 3, d = 2e3, e = "weixin-tool-menu-", f = e + "menu-edit-"; a.fn[b] = function (b) { g = a.extend({ getUrl: "/MenuTool?Operation=Get", saveUrl: "/MenuTool?Operation=Save", deleteUrl: "/MenuTool?Operation=Delete", getOAuthUrlUrl: "/MenuTool?Operation=GetOAuthUrl", oauthCallback: "" }, b), k(a(this)) } }(jQuery);