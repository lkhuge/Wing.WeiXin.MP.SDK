/*!
 * Weixin JS Menu Tool v0.0.4
 * 用于图形化操作菜单
 *
 * Dependency：
 * 1.JQuery
 * 2.Bootstrap(V3)
 *
 * Update(v0.0.4)：
 * [Fix]修正当菜单不存在时无法操作的问题
 * 
 * Usage：
 * $('#main').weixinmenu({
 *     getUrl: '/Menu?Operation=Get',       //获取菜单APIUrl
 *     saveUrl: '/Menu?Operation=Save',     //保存菜单APIUrl
 *     deleteUrl: '/Menu?Operation=Delete'  //删除菜单APIUrl
 * });
 */
!function (a) { "use strict"; function g(a) { var e, b = '<div id="' + d + 'operate" class="btn-group" role="group">' + '<button type="button" id="' + d + 'operate-refrush" class="btn btn-primary">刷新菜单</button>' + '<button type="button" id="' + d + 'operate-save" class="btn btn-success">保存菜单</button>' + '<button type="button" id="' + d + 'operate-delete" class="btn btn-warning">删除菜单</button>' + "</div>" + '<div id="' + d + 'main" class="panel-group" role="tablist" aria-multiselectable="true">'; for (e = 0; c > e; e++) b += '<div class="panel panel-default"><div class="panel-heading" role="tab" id="' + d + "heading-" + e + '" data-toggle="collapse" data-parent="#' + d + 'main" data-target="#' + d + "collapse-" + e + '" aria-expanded="false" aria-controls="' + d + "collapse-" + e + '">' + "<h4>主菜单" + (e + 1) + "</h4>" + "</div>" + '<div id="' + d + "collapse-" + e + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="' + d + "heading-" + e + '">' + '<div class="panel-body">' + '<div class="panel panel-success">' + '<div id="' + d + "head-" + e + '" class="panel-heading"></div>' + '<div id="' + d + "body-" + e + '" class="panel-body"></div>' + '<div id="' + d + "footer-" + e + '" class="panel-footer btn-group" role="group"></div>' + "</div>" + "</div>" + "</div>" + "</div>"; a.html(b + "</div>"), h(a) } function h(b) { a("#" + d + "operate-refrush").click(function () { y(), g(b), a.getJSON(f.getUrl, function (a) { j(a), z() }) }), a("#" + d + "operate-save").click(function () { x("确定保存？", function () { y(), a.post(f.saveUrl, { Data: window.escape(JSON.stringify(i())) }, function (a) { z(), alert(a.msg) }) }) }), a("#" + d + "operate-delete").click(function () { x("确定删除？", function () { y(), a.post(f.deleteUrl, function (a) { z(), alert(a.msg) }) }) }) } function i() { var e, f, g, h, b = []; for (e = 0; c > e; e++) f = a("#" + d + "head-" + e).text(), "" != f && (g = a("#" + d + "head-" + e).data("menu-type"), "main" == g ? (h = [], a("#" + d + "body-" + e).children().children().each(function () { var b = a(this).find('p[data-menu-type="type"]').eq(0).data("menu-value"), c = a(this).find('p[data-menu-type="name"]').eq(0).data("menu-value"); h = "view" == b ? h.concat([{ name: c, type: b, url: a(this).find('p[data-menu-type="url"]').eq(0).data("menu-value") }]) : h.concat([{ name: c, type: b, key: a(this).find('p[data-menu-type="key"]').eq(0).data("menu-value") }]) }), b = b.concat([{ name: f, sub_button: h }])) : b = "view" == g ? b.concat([{ name: f, type: g, url: a("#" + d + "head-" + e).data("menu-url") }]) : b.concat([{ name: f, type: g, key: a("#" + d + "head-" + e).data("menu-key") }])); return { menu: { button: b } } } function j(b) { for (var e = 0; c > e; e++) e < b.button.length ? (a("#" + d + "head-" + e).text(b.button[e].name), k(e, b.button[e], !0, !0)) : m(e) } function k(b, c, e, f, g) { return "undefined" != typeof g && null != g ? (g.html(l(c)), void 0) : (e ? (a("#" + d + "head-" + b).text(c.name), "undefined" == typeof c.type ? (a("#" + d + "head-" + b).attr("data-menu-type", "main"), a("#" + d + "body-" + b).html('<ul class="list-group"></ul>'), "undefined" != typeof c.sub_button && c.sub_button.length > 0 && c.sub_button.forEach(function (c) { a("#" + d + "body-" + b).children().append('<li class="list-group-item ' + d + 'menu-item">' + l(c) + "</li>") }), m(b, a("#" + d + "body-" + b).children().children().length)) : (a("#" + d + "head-" + b).attr("data-menu-type", c.type), "view" == c.type ? a("#" + d + "head-" + b).attr("data-menu-url", c.url) : a("#" + d + "head-" + b).attr("data-menu-key", c.key), a("#" + d + "body-" + b).html(l(c)), m(b, -1))) : (a("#" + d + "body-" + b).children().append('<li class="list-group-item ' + d + 'menu-item">' + l(c) + "</li>"), m(b, a("#" + d + "body-" + b).children().children().length)), a("." + d + "menu-item").unbind(), a("." + d + "menu-item").click(function () { u(!1, !1, b, a(this)) }), void 0) } function l(a) { var b = '<p data-menu-type="name" data-menu-value="' + a.name + '"><strong>显示标题：' + a.name + "</strong></p>", c = '<p data-menu-type="type" data-menu-value="' + a.type + '">类型：' + a.type + "(" + s(a.type) + ")</p>", d = "view" == a.type ? '<p data-menu-type="url" data-menu-value="' + a.url + '">URL：' + a.url + "</p>" : '<p data-menu-type="key" data-menu-value="' + a.key + '">Key：' + a.key + "</p>"; return b + c + d } function m(a, b) { return "undefined" == typeof b ? (r(a, !0), void 0) : 0 > b ? (q(a, !0), p(a), void 0) : 0 == b ? (n(a, !0), q(a), p(a), void 0) : 5 == b ? (q(a, !0), o(a), void 0) : (n(a, !0), q(a), o(a), void 0) } function n(b, c) { "undefined" != typeof c && c && a("#" + d + "footer-" + b).empty(); var e = '<button type="button" class="btn btn-info" data-menu-event="AddSub" data-menu-id="' + b + '">添加子菜单</button>'; a("#" + d + "footer-" + b).append(e), a('button[data-menu-event="AddSub"][data-menu-id="' + b + '"]').click(function () { u(!0, !1, b) }) } function o(b, c) { "undefined" != typeof c && c && a("#" + d + "footer-" + b).empty(); var e = '<button type="button" class="btn btn-warning" data-menu-event="DeleteSub" data-menu-id="' + b + '">删除子菜单</button>'; a("#" + d + "footer-" + b).append(e), a('button[data-menu-event="DeleteSub"][data-menu-id="' + b + '"]').click(function () { x("确定删除？", function () { a("#" + d + "body-" + b).children().children().remove("li:last"); var c = a("#" + d + "body-" + b).children().children(); m(b, c.length) }) }) } function p(b, c) { "undefined" != typeof c && c && a("#" + d + "footer-" + (b + 1)).empty(); var e = '<button type="button" class="btn btn-danger" data-menu-event="DeleteMain" data-menu-id="' + b + '">删除主菜单</button>'; a("#" + d + "footer-" + b).append(e), a('button[data-menu-event="DeleteMain"][data-menu-id="' + b + '"]').click(function () { x("确定删除？", function () { a("#" + d + "head-" + b).removeAttr("data-menu-type"), a("#" + d + "head-" + b).empty(), a("#" + d + "body-" + b).empty(), a("#" + d + "footer-" + b).empty(), m(b) }) }) } function q(b, c) { "undefined" != typeof c && c && a("#" + d + "footer-" + b).empty(); var e = '<button type="button" class="btn btn-primary" data-menu-event="ModityMain" data-menu-id="' + b + '">修改主菜单</button>'; a("#" + d + "footer-" + b).append(e), a('button[data-menu-event="ModityMain"][data-menu-id="' + b + '"]').click(function () { u(!1, !0, b) }) } function r(b, c) { "undefined" != typeof c && c && a("#" + d + "footer-" + b).empty(); var e = '<button type="button" class="btn btn-success" data-menu-event="AddMain" data-menu-id="' + b + '">添加主菜单</button>'; a("#" + d + "footer-" + b).append(e), a('button[data-menu-event="AddMain"][data-menu-id="' + b + '"]').click(function () { u(!0, !0, b) }) } function s(a) { return "click" == a ? "点击推事件" : "view" == a ? "跳转URL" : "scancode_push" == a ? "扫码推事件" : "scancode_waitmsg" == a ? "扫码推事件且弹出“消息接收中”提示框" : "pic_sysphoto" == a ? "弹出系统拍照发图" : "pic_photo_or_album" == a ? "弹出拍照或者相册发图" : "pic_weixin" == a ? "弹出微信相册发图器" : "location_select" == a ? "弹出地理位置选择器" : "未知类型" } function t(a, b) { var c = "undefined" != typeof b && null != b, d = ""; return a && (d += '<option value="main"' + (c && "main" == b ? 'selected="selected"' : "") + ">主菜单</option>"), d += '<option value="click"' + (c && "click" == b ? 'selected="selected"' : "") + ">点击推事件</option>" + '<option value="view"' + (c && "view" == b ? 'selected="selected"' : "") + ">跳转URL</option>" + '<option value="scancode_push"' + (c && "scancode_push" == b ? 'selected="selected"' : "") + ">扫码推事件</option>" + '<option value="scancode_waitmsg"' + (c && "scancode_waitmsg" == b ? 'selected="selected"' : "") + ">扫码推事件且弹出“消息接收中”提示框</option>" + '<option value="pic_sysphoto"' + (c && "pic_sysphoto" == b ? 'selected="selected"' : "") + ">弹出系统拍照发图</option>" + '<option value="pic_photo_or_album"' + (c && "pic_photo_or_album" == b ? 'selected="selected"' : "") + ">弹出拍照或者相册发图</option>" + '<option value="pic_weixin"' + (c && "pic_weixin" == b ? 'selected="selected"' : "") + ">弹出微信相册发图器</option>" + '<option value="location_select"' + (c && "location_select" == b ? 'selected="selected"' : "") + ">弹出地理位置选择器</option>" } function u(b, c, f, g) { var h, i; a("body").append('<div id="' + e + 'main" class="modal fade" role="dialog" aria-hidden="true">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-header">' + '<h4 class="modal-title">' + (b ? "新建" : "修改") + (c ? "主" : "子") + "菜单</h4>" + "</div>" + '<div id="' + e + 'body" class="modal-body">' + '<div class="form-group">' + '<label for="' + e + 'name" class="sr-only">菜单名称</label>' + '<div class="input-group">' + '<input type="text" id="' + e + 'name" name="name" class="form-control" placeholder="菜单名称">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-book"></div>' + "</div>" + "</div>" + "</div>" + "</div>" + '<div class="modal-footer">' + '<button type="button" id="' + e + 'save" class="btn btn-primary">保存</button>' + '<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>' + "</div>" + "</div>" + "</div>" + "</div>"), b || a("#" + e + "name").val(c ? a("#" + d + "head-" + f).text() : g.find('p[data-menu-type="name"]').eq(0).data("menu-value")), h = b || "main" != a("#" + d + "head-" + f).data("menu-type") || 0 == a("#" + d + "body-" + f).children().children().length, h && (i = b ? null : c ? a("#" + d + "head-" + f).data("menu-type") : g.find('p[data-menu-type="type"]').eq(0).data("menu-value"), a("#" + e + "body").append('<div class="form-group"><label for="' + e + 'type" class="sr-only">菜单类型</label>' + '<div class="input-group">' + '<select id="' + e + 'type" name="type" class="form-control">' + t(c, i) + "</select>" + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-th-list"></div>' + "</div>" + "</div>" + "</div>"), a("#" + e + "body").append(w(f, a("#" + e + "type").val(), c, g)), a("#" + e + "type").change(function () { var b = a(this).val(); a("#" + e + "body").append(w(f, b, c, g)) })), a("#" + e + "main").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + e + "save").click(function () { v(b, c, f, h, g) }), a("#" + e + "main").modal("show") } function v(b, c, f, g, h) { var j, l, m, n, i = a("#" + e + "name").val(); if (0 == i.length) return alert("主菜单名称不能为空"), void 0; if (i.length > 16) return alert("主菜单名称不能超过16个字节"), void 0; if (g) { if (j = a("#" + e + "type").val(), l = { name: i }, "main" != j) if (l = a.extend({ type: j }, l), "view" == j) { if (m = a("#" + e + "url").val(), l = a.extend({ url: m }, l), 0 == m.length) return alert("URL不能为空"), void 0 } else if (n = a("#" + e + "key").val(), l = a.extend({ key: n }, l), 0 == n.length) return alert("Key不能为空"), void 0; c ? b ? "main" == j ? k(f, l, !0, !0) : k(f, l, !0, !0) : "main" == j ? k(f, l, !0, !1) : k(f, l, !0, !1) : b ? k(f, l, !1, !0) : k(f, l, !1, !1, h) } else a("#" + d + "head-" + f).text(i); a("#" + e + "main").modal("hide") } function w(b, c, f, g) { if (a("." + e + "arg").remove(), null == c) { if ("undefined" == typeof g || null == g) return ""; c = g.find('p[data-menu-type="type"]').eq(0).data("menu-value") } if ("main" == c) return ""; var h; return "view" == c ? (h = f ? a("#" + d + "head-" + b).data("menu-type") == c ? a("#" + d + "head-" + b).data("menu-url") : "" : null != g && g.find('p[data-menu-type="type"]').eq(0).data("menu-value") == c ? g.find('p[data-menu-type="url"]').eq(0).data("menu-value") : "", '<div class="form-group ' + e + 'arg">' + '<label for="' + e + 'url" class="sr-only">URL</label>' + '<div class="input-group">' + '<input type="text" id="' + e + 'url" name="url" value="' + h + '" class="form-control" placeholder="URL">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-pencil"></div>' + "</div>" + "</div>" + "</div>") : (h = f ? a("#" + d + "head-" + b).data("menu-type") == c ? a("#" + d + "head-" + b).data("menu-key") : "" : null != g && g.find('p[data-menu-type="type"]').eq(0).data("menu-value") == c ? g.find('p[data-menu-type="key"]').eq(0).data("menu-value") : "", '<div class="form-group ' + e + 'arg">' + '<label for="' + e + 'key" class="sr-only">Key</label>' + '<div class="input-group">' + '<input type="text" id="' + e + 'key" name="key" value="' + h + '" class="form-control" placeholder="Key">' + '<div class="input-group-addon">' + '<div class="glyphicon glyphicon-pencil"></div>' + "</div>" + "</div>" + "</div>") } function x(b, c) { a("body").append('<div id="' + d + 'confirm" class="modal fade" role="dialog" aria-hidden="true">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-header">' + '<h4 class="modal-title">提示</h4>' + "</div>" + '<div class="modal-body">' + "<p><strong>" + b + "</strong></p>" + "</div>" + '<div class="modal-footer">' + '<button type="button" id="' + d + 'confirm-ok" class="btn btn-primary">确定</button>' + '<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>' + "</div>" + "</div>" + "</div>" + "</div>"), a("#" + d + "confirm").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + d + "confirm-ok").click(function () { c(), a("#" + d + "confirm").modal("hide") }), a("#" + d + "confirm").modal("show") } function y() { a("body").append('<div id="' + d + 'loading" class="modal fade" data-backdrop="static">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-body">' + "<p>Loading。。。</p>" + "</div>" + "</div>" + "</div>" + "</div>"), a("#" + d + "loading").on("hidden.bs.modal", function () { a(this).remove() }), a("#" + d + "loading").modal("show") } function z() { a("#" + d + "loading").modal("hide") } var f, b = "weixinmenu", c = 3, d = "weixin-tool-menu-", e = d + "menu-edit-"; a.fn[b] = function (b) { f = a.extend({ getUrl: "/MenuTool?Operation=Get", saveUrl: "/MenuTool?Operation=Save", deleteUrl: "/MenuTool?Operation=Delete" }, b), y(), g(a(this)), a.getJSON(f.getUrl, function (a) { "undefined" != typeof a.msg && (alert(a.msg), a = { button: [] }), j(a), z() }) } }(jQuery);